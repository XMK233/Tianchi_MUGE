# 电商商品标签生成方案

## 方案概述

本方案基于Qwen-VL多模态模型，通过分析电商商品的文本描述，为每个商品生成对应的电商标签（如女装、男装、家具、数码、美妆等）。

## 目录结构

```
plan_2/
├── generate_product_labels.py  # 主脚本文件
├── README.md                   # 方案说明文档
└── outputs/                    # 输出结果目录
    ├── IC_train_labels.jsonl   # 训练集标签结果
    ├── IC_valid_labels.jsonl   # 验证集标签结果
    ├── IC_test_labels.jsonl    # 测试集标签结果
    └── label_statistics.json   # 标签统计信息
```

## 环境要求

- Python 3.8+
- PyTorch 2.0+
- Transformers 4.30+
- CUDA 11.0+（推荐使用GPU加速）

## 数据准备

### 数据集路径

默认数据集路径为：
```
/mnt/d/forCoding_data/Tianchi_MUGE/originalData/ECommerce-IC
```

### 数据格式

支持的JSONL文件格式：

```json
{
  "img_id": "021c1bfef2081875736a11f58583de97",
  "text": [
    "彰显干净利落气质，简约风穿搭。",
    "春暖花开，百花齐放，争奇斗艳，百褶裙来",
    "春装黑白配，性感V领衬衫配高腰半身裙"
  ]
}
```

## 模型配置

### 模型路径

默认使用Qwen2.5-VL-3B-Instruct模型，路径为：
```
/mnt/d/HuggingFaceModels/models--Qwen--Qwen2.5-VL-3B-Instruct
```

### 模型加载方式

采用与4.2_益-基于4.1_用较小规模数据集尝试.py中一致的模型加载方式：

1. **离线模式加载**：设置`TRANSFORMERS_OFFLINE=1`确保不进行网络请求
2. **自动设备分配**：优先使用GPU加速，无GPU则自动回退到CPU
3. **TF32加速**：在支持的GPU上启用TF32计算以提高性能
4. **模型类自动选择**：自动检测可用的Qwen-VL模型类

## 使用方法

### 运行脚本

```bash
cd /mnt/d/forCoding_code/Tianchi_MUGE/ECommerce-IC/plan_2
python generate_product_labels.py
```

### 自定义配置

可以在脚本中修改以下参数：

- `DATASET_DIR`：数据集路径
- `MODEL_DIR`：模型路径
- `OUTPUT_DIR`：输出结果路径

## 输出结果说明

### 标签结果文件

每个JSONL文件对应生成一个包含标签的结果文件，格式如下：

```json
{
  "image_id": "021c1bfef2081875736a11f58583de97",
  "label": "女装",
  "original_text": [
    "彰显干净利落气质，简约风穿搭。",
    "春暖花开，百花齐放，争奇斗艳，百褶裙来"
  ]
}
```

### 标签统计文件

生成`label_statistics.json`文件，包含以下统计信息：

- 每个数据集的标签分布
- 所有数据的整体标签分布
- 出现频率最高的标签

## 实现细节

### 文本处理

- 将每个商品的多条文本描述合并为一条完整描述
- 构建清晰的提示模板，引导模型生成准确的标签

### 模型推理

- 使用贪婪解码（`do_sample=False`）确保生成结果的一致性
- 限制生成长度（`max_new_tokens=10`）避免冗余输出
- 批量处理输入，提高处理效率

### 错误处理

- 对无效JSON行进行跳过处理
- 对模型生成失败的情况返回"未知"标签
- 详细记录处理过程中的错误信息

## 性能优化

1. **GPU加速**：优先使用GPU进行推理，提高处理速度
2. **批量处理**：采用批量输入方式，减少GPU内存开销
3. **内存管理**：使用`torch.no_grad()`避免梯度计算，节省内存

## 预期效果

- 为每个商品生成一个主要的电商标签
- 支持大规模数据处理
- 输出结果易于后续分析和使用

## 扩展建议

1. **多标签生成**：修改提示模板，支持生成多个标签
2. **标签细化**：生成更细粒度的标签（如连衣裙、牛仔裤、智能手机等）
3. **模型微调**：使用标注数据对模型进行微调，提高标签准确性
4. **图像结合**：结合商品图片信息，提高标签生成的准确性
